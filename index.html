<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pool Score Tracker FINAL FULL</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {background: linear-gradient(to bottom right,#111827,#000,#1e3a8a);color:white;min-height:100vh;}
    .tab{padding:12px 20px;border-radius:16px;font-weight:bold;cursor:pointer;flex:1;text-align:center;}
    .tab.active{background:#facc15;color:black;}
    .card{background:rgba(255,255,255,0.08);border-radius:20px;padding:18px;box-shadow:0 0 20px rgba(0,0,0,0.4);}
    .btn{padding:10px 14px;border-radius:14px;font-weight:bold;width:100%;transition:0.2s;}
    .btn:hover{transform:scale(1.03);}
    .score{font-size:3rem;font-weight:900;text-align:center;}
    .bar{height:18px;border-radius:10px;background:#facc15;}
    .history{background:rgba(255,255,255,0.12);padding:16px;border-radius:18px;max-height:200px;overflow-y:auto;}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.75);z-index:50;}
    .modal.active{display:flex;}
    .modal-content{background:#111827;padding:25px;border-radius:20px;max-width:550px;width:90%;}
  </style>
</head>
<body class="p-4 sm:p-8">

<h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-6">üé± Pool Score Tracker</h1>

<!-- Tabs -->
<div class="flex gap-2 mb-6">
  <div id="tab9" class="tab active">9-Ball</div>
  <div id="tab8" class="tab">8-Ball</div>
</div>

<!-- Break Order -->
<div class="max-w-2xl mx-auto mb-6 text-center">
  <div class="card">
    <h2 class="text-xl font-bold">üé≤ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏° (‡∏™‡∏∏‡πà‡∏°)</h2>
    <div id="breakOrder" class="text-yellow-300 font-bold"></div>
    <button id="shuffleBtn" class="btn bg-blue-500 mt-3">üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
  </div>
</div>

<!-- Add Player -->
<div class="max-w-xl mx-auto flex flex-col gap-3 mb-6">
  <input id="playerName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô..." class="px-4 py-3 rounded-xl text-black"/>
  <button id="addBtn" class="btn bg-yellow-400 text-black">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</button>
  <button id="endBtn" class="btn bg-red-500">‚úÖ ‡∏à‡∏ö‡∏ß‡∏±‡∏ô / ‡∏à‡∏ö Season</button>
  <button id="clearPlayersBtn" class="btn bg-red-700">üóë ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button id="clearHistoryBtn" class="btn bg-red-900">üî• ‡∏•‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>

<!-- Players Grid -->
<div id="playersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10"></div>

<!-- Analytics -->
<div class="max-w-4xl mx-auto space-y-6">
  <div class="card"><h2 class="text-2xl font-bold mb-3">üèÖ Leaderboard ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h2><div id="leaderboard"></div></div>
  <div class="card"><h2 class="text-2xl font-bold mb-3">üìà ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h2><div id="winnerChart"></div></div>
  <div class="card"><h2 class="text-2xl font-bold mb-3">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</h2><div id="avgChart"></div></div>
  <div><h2 class="text-2xl font-bold mb-3">üìÖ History</h2><div id="historyBox" class="history"></div></div>
</div>

<!-- Popup Score Modal -->
<div id="scoreModal" class="modal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
    <button id="normalBtn" class="btn bg-green-600 mb-2">‚ûï +1 ‡∏õ‡∏Å‡∏ï‡∏¥</button>
    <button id="nineBtn" class="btn bg-purple-600 mb-2">üé± +1 ‡∏•‡∏π‡∏Å9 SuddenDeath</button>
    <button onclick="closeScoreModal()" class="btn bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<!-- Summary Modal -->
<div id="summaryModal" class="modal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-3">‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
    <div id="summaryContent"></div>
    <button onclick="closeSummary()" class="btn bg-yellow-400 text-black mt-4">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyADx5Fjh1OuUGyxxmuvzBMnNW09iizwEwc",
 authDomain:"poolscoretracker-abc76.firebaseapp.com",
 projectId:"poolscoretracker-abc76",
 messagingSenderId:"398668828315",
 appId:"1:398668828315:web:b59ac77fa48458c8be803e"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let mode="9ball";
let players=[];
let history=[];
let breakQueue=[];
let lastFirst=null;
let firstRepeat=0;
let selectedIndex=null;

const grid=document.getElementById("playersGrid");
const breakOrderEl=document.getElementById("breakOrder");
const leaderboardEl=document.getElementById("leaderboard");
const winnerChartEl=document.getElementById("winnerChart");
const avgChartEl=document.getElementById("avgChart");
const historyBox=document.getElementById("historyBox");

const scoreModal=document.getElementById("scoreModal");
const summaryModal=document.getElementById("summaryModal");
const summaryContent=document.getElementById("summaryContent");

async function saveData(){
 await setDoc(doc(db,"pool",mode),{players,history,breakQueue,lastFirst,firstRepeat});
}
async function loadData(){
 const snap=await getDoc(doc(db,"pool",mode));
 if(snap.exists()){
  const d=snap.data();
  players=d.players||[];
  history=d.history||[];
  breakQueue=d.breakQueue||[];
  lastFirst=d.lastFirst||null;
  firstRepeat=d.firstRepeat||0;
 }
}

function randomBreakOrder(){
 if(players.length<2) return;
 let list=[...players.map(p=>p.name)];
 for(let i=list.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [list[i],list[j]]=[list[j],list[i]];
 }
 if(list[0]===lastFirst){
  firstRepeat++;
  if(firstRepeat>2){
   list.push(list.shift());
   firstRepeat=1;
  }
 } else firstRepeat=1;
 lastFirst=list[0];
 breakQueue=list;
 updateBreakOrder();
 saveData();
}
function updateBreakOrder(){
 breakOrderEl.textContent=breakQueue.length?breakQueue.join(" ‚Üí "):"(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°)";
}

function openScoreModal(i){
 selectedIndex=i;
 scoreModal.classList.add("active");
 document.getElementById("nineBtn").style.display=(mode==="9ball")?"block":"none";
}
window.closeScoreModal=()=>scoreModal.classList.remove("active");

function addScore(amount){
 players[selectedIndex].score+=amount;
 closeScoreModal();
 if(mode==="9ball") randomBreakOrder();
 saveData();
 refresh();
}

function subScore(i){
 players[i].score--; if(players[i].score<0) players[i].score=0;
 if(mode==="9ball") randomBreakOrder();
 saveData();
 refresh();
}

function renderPlayers(){
 grid.innerHTML="";
 players.forEach((p,i)=>{
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
   <h3 class="text-xl font-bold text-center mb-2">${p.name}</h3>
   <div class="score mb-3">${p.score}</div>
   <button class="btn bg-green-600 mb-2" onclick="openScoreModal(${i})">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
   <button class="btn bg-gray-600 mb-2" onclick="subScore(${i})">‚ûñ ‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
   <button class="btn bg-red-600" onclick="deletePlayer(${i})">üóë ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
  `;
  grid.appendChild(card);
 });
}

async function deletePlayer(i){
 if(!confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô?") ) return;
 players.splice(i,1);
 await saveData();
 refresh();
}

// Analytics
function monthKey(dateStr){
 const [d,m,y]=dateStr.split("/"); return `${m}/${y}`;
}
function currentMonthKey(){
 return monthKey(new Date().toLocaleDateString("th-TH"));
}

function renderLeaderboard(){
 const wins={};
 const current=currentMonthKey();
 history.forEach(r=>{ if(monthKey(r.date)===current) wins[r.winner]=(wins[r.winner]||0)+1; });
 let sorted=Object.entries(wins).sort((a,b)=>b[1]-a[1]);
 if(sorted.length===0){leaderboardEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";return;}
 const medals=["ü•á","ü•à","ü•â"];
 leaderboardEl.innerHTML=sorted.map(([n,c],i)=>`<div class="flex justify-between mb-2"><span>${i<3?medals[i]:""} ${n}</span><span>${c} Wins</span></div>`).join("");
}

function renderWinnerChart(){
 const wins={};
 history.forEach(r=>wins[r.winner]=(wins[r.winner]||0)+1);
 let sorted=Object.entries(wins).sort((a,b)=>b[1]-a[1]);
 if(sorted.length===0){winnerChartEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";return;}
 const max=sorted[0][1];
 winnerChartEl.innerHTML=sorted.map(([n,c])=>`<div class="mb-3"><div class="flex justify-between text-sm"><span>${n}</span><span>${c}</span></div><div class="w-full bg-white/10 rounded-xl"><div class="bar" style="width:${(c/max)*100}%"></div></div></div>`).join("");
}

function renderAvgChart(){
 const daily={};
 history.forEach(r=>{ if(!daily[r.date]) daily[r.date]=[]; daily[r.date].push(r.winnerScore); });
 const entries=Object.entries(daily);
 if(entries.length===0){avgChartEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";return;}
 avgChartEl.innerHTML=entries.map(([date,scores])=>{
  const avg=scores.reduce((a,b)=>a+b,0)/scores.length;
  return `<div class="mb-3"><div class="flex justify-between text-sm"><span>${date}</span><span>${avg.toFixed(1)}</span></div><div class="w-full bg-white/10 rounded-xl"><div class="bar" style="width:${avg*10}%"></div></div></div>`;
 }).join("");
}

function renderHistory(){
 historyBox.innerHTML="";
 history.forEach(h=>{
  const div=document.createElement("div");
  div.className="p-2 mb-2 rounded-xl bg-black/40";
  div.textContent=`${h.date} | Winner: ${h.winner}`;
  historyBox.appendChild(div);
 });
}

function refresh(){
 renderPlayers();
 updateBreakOrder();
 renderLeaderboard();
 renderWinnerChart();
 renderAvgChart();
 renderHistory();
}

// End Game
function endGame(){
 const today=new Date().toLocaleDateString("th-TH");
 const sorted=[...players].sort((a,b)=>b.score-a.score);
 const winner=sorted[0];
 if(!winner){alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");return;}

 let record={date:today,winner:winner.name,winnerScore:winner.score};
 history.unshift(record);

 summaryContent.textContent=`üìÖ ${today}\nüèÜ Winner: ${winner.name} (${winner.score})`;
 summaryModal.classList.add("active");

 players.forEach(p=>p.score=0);
 saveData();
 refresh();
}
window.closeSummary=()=>summaryModal.classList.remove("active");

// Buttons

document.getElementById("addBtn").addEventListener("click",async()=>{
 const name=document.getElementById("playerName").value.trim();
 if(!name)return;
 players.push({name,score:0});
 await saveData();
 refresh();
});

document.getElementById("shuffleBtn").addEventListener("click",randomBreakOrder);

document.getElementById("endBtn").addEventListener("click",endGame);

document.getElementById("clearPlayersBtn").addEventListener("click",async()=>{
 if(!confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?") ) return;
 players=[]; await saveData(); refresh();
});

document.getElementById("clearHistoryBtn").addEventListener("click",async()=>{
 if(!confirm("‡∏•‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?") ) return;
 history=[]; await saveData(); refresh();
});

// Tabs
async function switchMode(newMode){
 mode=newMode;
 await loadData();
 refresh();
 document.getElementById("tab9").classList.toggle("active",mode==="9ball");
 document.getElementById("tab8").classList.toggle("active",mode==="8ball");
}

document.getElementById("tab9").addEventListener("click",()=>switchMode("9ball"));
document.getElementById("tab8").addEventListener("click",()=>switchMode("8ball"));

// Modal Buttons

document.getElementById("normalBtn").addEventListener("click",()=>addScore(1));
document.getElementById("nineBtn").addEventListener("click",()=>addScore(1));

// Init
await switchMode("9ball");

window.openScoreModal=openScoreModal;
window.subScore=subScore;
window.deletePlayer=deletePlayer;
</script>

</body>
</html>
