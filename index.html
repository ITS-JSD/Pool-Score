<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pool Score Tracker FINAL FIXED</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {background: linear-gradient(to bottom right,#111827,#000,#1e3a8a);color:white;min-height:100vh;}
    .tab{padding:12px 20px;border-radius:16px;font-weight:bold;cursor:pointer;flex:1;text-align:center;}
    .tab.active{background:#facc15;color:black;}
    .card{background:rgba(255,255,255,0.08);border-radius:20px;padding:18px;box-shadow:0 0 20px rgba(0,0,0,0.4);}
    .btn{padding:10px 14px;border-radius:14px;font-weight:bold;width:100%;transition:0.2s;}
    .btn:hover{transform:scale(1.03);}
    .score{font-size:3rem;font-weight:900;text-align:center;}
    .bar{height:18px;border-radius:10px;background:#facc15;}
    .history{background:rgba(255,255,255,0.12);padding:16px;border-radius:18px;max-height:200px;overflow-y:auto;}

    .modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.75);z-index:50;}
    .modal.active{display:flex;}
    .modal-content{background:#111827;padding:25px;border-radius:20px;max-width:520px;width:90%;}
  </style>
</head>
<body class="p-4 sm:p-8">

<h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-6">üé± Pool Score Tracker</h1>

<div class="flex gap-2 mb-6">
  <div id="tab9" class="tab active">9-Ball</div>
  <div id="tab8" class="tab">8-Ball</div>
</div>

<div class="max-w-2xl mx-auto mb-6 text-center">
  <div class="card">
    <h2 class="text-xl font-bold">üé≤ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏° (‡∏™‡∏∏‡πà‡∏°)</h2>
    <div id="breakOrder" class="text-yellow-300 font-bold"></div>
    <button id="shuffleBtn" class="btn bg-blue-500 mt-3">üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
  </div>
</div>

<div class="max-w-xl mx-auto flex flex-col gap-3 mb-6">
  <input id="playerName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô..." class="px-4 py-3 rounded-xl text-black"/>
  <button id="addBtn" class="btn bg-yellow-400 text-black">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</button>
  <button id="endBtn" class="btn bg-red-500">‚úÖ ‡∏à‡∏ö‡∏ß‡∏±‡∏ô / ‡∏à‡∏ö Season</button>
</div>

<div id="playersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10"></div>

<div class="max-w-4xl mx-auto space-y-6">
  <div class="card"><h2 class="text-2xl font-bold mb-3">üèÖ Leaderboard ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h2><div id="leaderboard"></div></div>
  <div class="card"><h2 class="text-2xl font-bold mb-3">üìà ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h2><div id="winnerChart"></div></div>
  <div class="card"><h2 class="text-2xl font-bold mb-3">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</h2><div id="avgChart"></div></div>
  <div><h2 class="text-2xl font-bold mb-3">üìÖ History</h2><div id="historyBox" class="history"></div></div>
</div>

<!-- Score Modal -->
<div id="scoreModal" class="modal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
    <button id="normalBtn" class="btn bg-green-600 mb-2">‚ûï +1 ‡∏õ‡∏Å‡∏ï‡∏¥</button>
    <button id="nineBtn" class="btn bg-purple-600 mb-2">üé± +1 ‡∏•‡∏π‡∏Å9‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏Å‡∏°</button>
    <button onclick="closeScoreModal()" class="btn bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<!-- Summary Modal -->
<div id="summaryModal" class="modal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-3">‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
    <div id="summaryContent"></div>
    <button onclick="closeSummary()" class="btn bg-yellow-400 text-black mt-4">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyADx5Fjh1OuUGyxxmuvzBMnNW09iizwEwc",authDomain:"poolscoretracker-abc76.firebaseapp.com",projectId:"poolscoretracker-abc76",messagingSenderId:"398668828315",appId:"1:398668828315:web:b59ac77fa48458c8be803e"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let mode="9ball";
let players=[];
let history=[];
let breakQueue=[];
let selectedIndex=null;

const grid=document.getElementById("playersGrid");
const breakOrderEl=document.getElementById("breakOrder");
const leaderboardEl=document.getElementById("leaderboard");
const historyBox=document.getElementById("historyBox");
const scoreModal=document.getElementById("scoreModal");
const summaryModal=document.getElementById("summaryModal");
const summaryContent=document.getElementById("summaryContent");

async function saveData(){await setDoc(doc(db,"pool",mode),{players,history,breakQueue});}
async function loadData(){const snap=await getDoc(doc(db,"pool",mode));if(snap.exists()){const d=snap.data();players=d.players||[];history=d.history||[];breakQueue=d.breakQueue||[];}}

function randomBreakOrder(){if(players.length<2) return;breakQueue=[...players.map(p=>p.name)].sort(()=>Math.random()-0.5);updateBreakOrder();saveData();}
function updateBreakOrder(){breakOrderEl.textContent=breakQueue.length?breakQueue.join(" ‚Üí "):"(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°)";}

function openScoreModal(i){selectedIndex=i;scoreModal.classList.add("active");document.getElementById("nineBtn").style.display=(mode==="9ball")?"block":"none";}
window.closeScoreModal=()=>scoreModal.classList.remove("active");

function addNormal(){players[selectedIndex].score++;closeScoreModal();if(mode==="9ball") randomBreakOrder();saveData();refresh();}
function addNine(){players[selectedIndex].score++;players[selectedIndex].nineMid=(players[selectedIndex].nineMid||0)+1;closeScoreModal();if(mode==="9ball") randomBreakOrder();saveData();refresh();}

function subScore(i){players[i].score--;if(players[i].score<0)players[i].score=0;if(mode==="9ball")randomBreakOrder();saveData();refresh();}

function renderPlayers(){grid.innerHTML="";players.forEach((p,i)=>{
 const card=document.createElement("div");card.className="card";
 card.innerHTML=`
  <h3 class="text-xl font-bold text-center mb-2">${p.name}</h3>
  <div class="score mb-2">${p.score}</div>
  ${mode==="9ball"?`<p class="text-sm text-center text-purple-300">‡∏•‡∏π‡∏Å9‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏Å‡∏°: ${p.nineMid||0}</p>`:""}
  <button class="btn bg-green-600 mt-2" onclick="openScoreModal(${i})">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
  <button class="btn bg-gray-600 mt-2" onclick="subScore(${i})">‚ûñ ‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
 `;
 grid.appendChild(card);
});}

function renderHistory(){historyBox.innerHTML="";history.forEach(h=>{const div=document.createElement("div");div.className="p-2 mb-2 rounded-xl bg-black/40";div.textContent=h.title;historyBox.appendChild(div);});}

function refresh(){renderPlayers();updateBreakOrder();renderHistory();}

function endGame(){const today=new Date().toLocaleDateString("th-TH");
 const sorted=[...players].sort((a,b)=>b.score-a.score);const winner=sorted[0];
 let nineCount=winner.nineMid||0;
 let detail=`üìÖ ${today}\nüèÜ Winner: ${winner.name} (${winner.score})`;
 if(mode==="9ball") detail+=`\nüé± ‡∏•‡∏π‡∏Å9‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏Å‡∏°: ${nineCount}`;
 history.unshift({title:`${mode.toUpperCase()} | ${today} | Winner: ${winner.name}`,detail});
 summaryContent.textContent=detail;summaryModal.classList.add("active");
 players.forEach(p=>{p.score=0;p.nineMid=0;});
 saveData();refresh();}
window.closeSummary=()=>summaryModal.classList.remove("active");

// Events

document.getElementById("addBtn").addEventListener("click",async()=>{const name=document.getElementById("playerName").value.trim();if(!name)return;players.push({name,score:0,nineMid:0});await saveData();refresh();});

document.getElementById("shuffleBtn").addEventListener("click",randomBreakOrder);
document.getElementById("endBtn").addEventListener("click",endGame);

document.getElementById("normalBtn").addEventListener("click",addNormal);
document.getElementById("nineBtn").addEventListener("click",addNine);

async function switchMode(newMode){mode=newMode;await loadData();refresh();document.getElementById("tab9").classList.toggle("active",mode==="9ball");document.getElementById("tab8").classList.toggle("active",mode==="8ball");}

document.getElementById("tab9").addEventListener("click",()=>switchMode("9ball"));
document.getElementById("tab8").addEventListener("click",()=>switchMode("8ball"));

await switchMode("9ball");

window.openScoreModal=openScoreModal;
</script>

</body>
</html>
