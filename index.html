<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pool Score Tracker (Full Analytics)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: linear-gradient(to bottom right, #111827, #000000, #1e3a8a);
      color: white;
      min-height: 100vh;
    }
    .tab {
      padding: 12px 20px;
      border-radius: 16px;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
      text-align: center;
    }
    .tab.active { background: #facc15; color: black; }

    .card {
      background: rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    .btn {
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: bold;
      width: 100%;
    }

    .history {
      background: rgba(255,255,255,0.12);
      padding: 16px;
      border-radius: 18px;
      max-height: 200px;
      overflow-y: auto;
    }

    .bar { height: 18px; border-radius: 10px; background: #facc15; }

    .medal { font-size: 1.4rem; }

  </style>
</head>

<body class="p-4 sm:p-8">

  <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-6">üé± Pool Score Tracker</h1>

  <!-- Tabs -->
  <div class="flex gap-2 mb-6">
    <div id="tab9" class="tab active">9-Ball</div>
    <div id="tab8" class="tab">8-Ball</div>
  </div>


  <!-- Players Grid -->
  <div id="playersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10"></div>


  <!-- Analytics Dashboard -->
  <div class="max-w-4xl mx-auto space-y-6">

    <!-- Leaderboard -->
    <div class="card">
      <h2 class="text-2xl font-bold mb-3">üèÖ Leaderboard (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h2>
      <div id="leaderboard"></div>
    </div>

    <!-- Winner Chart -->
    <div class="card">
      <h2 class="text-2xl font-bold mb-3">üìà ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h2>
      <div id="winnerChart"></div>
    </div>

    <!-- Avg Score Per Day -->
    <div class="card">
      <h2 class="text-2xl font-bold mb-3">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</h2>
      <div id="avgChart"></div>
    </div>


    <!-- History -->
    <div>
      <h2 class="text-2xl font-bold mb-3">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
      <div id="historyBox" class="history"></div>
    </div>

  </div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyADx5Fjh1OuUGyxxmuvzBMnNW09iizwEwc",
    authDomain: "poolscoretracker-abc76.firebaseapp.com",
    projectId: "poolscoretracker-abc76",
    storageBucket: "poolscoretracker-abc76.firebasestorage.app",
    messagingSenderId: "398668828315",
    appId: "1:398668828315:web:b59ac77fa48458c8be803e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let mode="9ball";
  let players=[];
  let history=[];

  const grid=document.getElementById("playersGrid");
  const historyBox=document.getElementById("historyBox");

  const leaderboardEl=document.getElementById("leaderboard");
  const winnerChartEl=document.getElementById("winnerChart");
  const avgChartEl=document.getElementById("avgChart");


  async function saveData(){
    await setDoc(doc(db,"pool",mode),{players,history});
  }

  async function loadData(){
    const snap=await getDoc(doc(db,"pool",mode));
    if(snap.exists()){
      const d=snap.data();
      players=d.players||[];
      history=d.history||[];
    }
  }


  // Render Players (simple)
  function renderPlayers(){
    grid.innerHTML="";
    players.forEach(p=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <h3 class="text-xl font-bold text-center">${p.name}</h3>
        <p class="text-center text-3xl font-extrabold">${p.score}</p>
      `;
      grid.appendChild(card);
    });
  }


  // ‚úÖ Filter Month Only
  function monthKey(dateStr){
    const [d,m,y]=dateStr.split("/");
    return `${m}/${y}`;
  }

  function currentMonthKey(){
    const now=new Date().toLocaleDateString("th-TH");
    return monthKey(now);
  }


  // ‚úÖ Leaderboard Top3 + Separate by Mode
  function renderLeaderboard(){
    const wins={};
    const current=currentMonthKey();

    history.forEach(r=>{
      if(monthKey(r.date)===current){
        wins[r.winner]=(wins[r.winner]||0)+1;
      }
    });

    let sorted=Object.entries(wins).sort((a,b)=>b[1]-a[1]);

    if(sorted.length===0){
      leaderboardEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
      return;
    }

    const medals=["ü•á","ü•à","ü•â"];

    leaderboardEl.innerHTML=sorted.slice(0,10).map(([name,count],i)=>{
      const medal=i<3?medals[i]:"";
      return `
        <div class="flex justify-between mb-2">
          <span class="font-bold">${medal} ${name}</span>
          <span>${count} Wins (${mode})</span>
        </div>
      `;
    }).join("");
  }


  // ‚úÖ Winner Frequency Chart
  function renderWinnerChart(){
    const wins={};
    history.forEach(r=>{ wins[r.winner]=(wins[r.winner]||0)+1; });

    let sorted=Object.entries(wins).sort((a,b)=>b[1]-a[1]);
    if(sorted.length===0){ winnerChartEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; }

    const max=sorted[0][1];

    winnerChartEl.innerHTML=sorted.map(([name,count])=>{
      return `
        <div class="mb-3">
          <div class="flex justify-between text-sm">
            <span>${name}</span><span>${count}</span>
          </div>
          <div class="w-full bg-white/10 rounded-xl">
            <div class="bar" style="width:${(count/max)*100}%"></div>
          </div>
        </div>
      `;
    }).join("");
  }


  // ‚úÖ Average Score Per Day Chart
  function renderAvgChart(){
    const daily={};

    history.forEach(r=>{
      if(!daily[r.date]) daily[r.date]=[];
      daily[r.date].push(r.winnerScore);
    });

    const entries=Object.entries(daily);
    if(entries.length===0){ avgChartEl.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; }

    avgChartEl.innerHTML=entries.map(([date,scores])=>{
      const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
      return `
        <div class="mb-3">
          <div class="flex justify-between text-sm">
            <span>${date}</span>
            <span>Avg Winner Score: ${avg.toFixed(1)}</span>
          </div>
          <div class="w-full bg-white/10 rounded-xl">
            <div class="bar" style="width:${avg*10}%"></div>
          </div>
        </div>
      `;
    }).join("");
  }


  // History List
  function renderHistory(){
    historyBox.innerHTML="";
    history.forEach(h=>{
      const div=document.createElement("div");
      div.className="p-2 mb-2 rounded-xl bg-black/40";
      div.textContent=`${h.date} | Winner: ${h.winner}`;
      historyBox.appendChild(div);
    });
  }


  // Switch Mode
  async function switchMode(newMode){
    mode=newMode;
    await loadData();

    renderPlayers();
    renderLeaderboard();
    renderWinnerChart();
    renderAvgChart();
    renderHistory();

    document.getElementById("tab9").classList.toggle("active",mode==="9ball");
    document.getElementById("tab8").classList.toggle("active",mode==="8ball");
  }

  document.getElementById("tab9").addEventListener("click",()=>switchMode("9ball"));
  document.getElementById("tab8").addEventListener("click",()=>switchMode("8ball"));

  await switchMode("9ball");
</script>

</body>
</html>
